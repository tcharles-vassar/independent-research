<html>
<head>
  <title>Experiment</title>
  <script src="jspsych-6/jspsych.js"></script>
  <script src="jspsych-6/plugins/jspsych-html-button-response.js"></script>
  <link href="jspsych-6/css/jspsych.css" rel="stylesheet" type="text/css"></link>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@2.0.0/dist/tf.min.js"></script>
  <script src="speech-commands.js"></script>

  <style type="text/css">
      .hidden {
          display: none;
      }

      .active {
          background-color: #090;
      }
  </style>

    <script type="text/javascript">
          let recognizer;
          let words;
          const wordList = ["zero","one","two","three","four","five","six","seven","eight","nine", "yes", "no", "up", "down", "left", "right", "stop", "go"];
          let modelLoaded = false;

          async function loadModel() {
              // Show the loading element
              //const loadingElement = document.getElementById('demo-loading');
              document.getElementById('jspsych-html-button-response-button-0').innerHTML='Loading...';

              // When calling `create()`, you must provide the type of the audio input.
              // - BROWSER_FFT uses the browser's native Fourier transform.
              recognizer = speechCommands.create("BROWSER_FFT");
              await recognizer.ensureModelLoaded()

              words = recognizer.wordLabels();
              modelLoaded = true;

              // Hide the loading element
              document.getElementById('jspsych-html-button-response-button-0').innerHTML='Say the word.';
              startListening();
          }

          function startListening() {
              recognizer.listen(({scores}) => {

                  // Everytime the model evaluates a result it will return the scores array
                  // Based on this data we will build a new array with each word and it's corresponding score
                  scores = Array.from(scores).map((s, i) => ({score: s, word: words[i]}));

                  // After that we sort the array by scode descending
                  scores.sort((s1, s2) => s2.score - s1.score);

                  // And we highlight the word with the highest score
                  const elementId = `word-${scores[0].word}`;
                  const guessWord = document.getElementById('jspsych-html-button-response-stimulus').innerHTML;
                  if(elementId == 'word-' + guessWord){
                    document.getElementById('jspsych-html-button-response-button-0').innerHTML='correct! Click here.';
                    recognizer.stopListening();
                  }
                  else{
                  //document.getElementById('jspsych-html-button-response-button-0').classList.add('hidden');
                  }
              },
              {
                  probabilityThreshold: 0.70
              });
          }

          function stopListening(){
              recognizer.stopListening();
          }

    var timeline = [];

        var trial1 = {
  type: "html-button-response",
  stimulus: 'four',

  choices: ['Say the word'],

  on_load: function(){
    if(modelLoaded) {
         startListening();
      }else{
           loadModel();
       }
  },

  on_finish: function(){
    stopListening();
  },
};
timeline.push(trial1);

var trial2 = {
type: "html-button-response",
stimulus: 'seven',

choices: ['Say the word'],

on_load: function(){
if(modelLoaded) {
 startListening();
}else{
   loadModel();
}
},

on_finish: function(){
stopListening();
},
};
timeline.push(trial2);

var trial3 = {
type: "html-button-response",
stimulus: 'eight',

choices: ['Say the word'],

on_load: function(){
if(modelLoaded) {
 startListening();
}else{
   loadModel();
}
},

on_finish: function(){
stopListening();
},
};

timeline.push(trial3);

jsPsych.init({
  timeline: timeline
});

    </script>
</head>
<body>
</body>
</html>
